<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí£ Bomb Puzzle Master</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0c0c0c;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow-y: auto;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            font-weight: bold;
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
            margin-bottom: 20px;
        }

        .columns {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        .hints-column {
            flex: 1;
            min-width: 400px;
        }

        .game-column {
            flex: 2;
            min-width: 600px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00ccff;
            margin-bottom: 15px;
            text-shadow: 0 0 5px #00ccff;
        }

        .hint-table {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .hint-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 5px;
        }

        .color-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #444;
            display: inline-block;
        }

        .timer-section {
            text-align: center;
            margin-bottom: 25px;
        }

        .time-display {
            font-family: 'Consolas', monospace;
            font-size: 2.2rem;
            color: #ff4444;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #ff4444;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffaa00);
            transition: width 1s linear;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-start {
            background: #228B22;
            color: white;
        }

        .btn-stop {
            background: #cc0000;
            color: white;
        }

        .btn-delete {
            background: #444;
            color: white;
        }

        .btn-submit {
            background: #228B22;
            color: white;
        }

        .current-input {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 10px;
        }

        .current-input-text {
            font-size: 1.4rem;
            color: white;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .color-tag {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            border: 2px solid transparent;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .color-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .color-btn {
            padding: 15px 25px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
            min-width: 120px;
        }

        .color-btn:hover {
            transform: scale(1.05);
        }

        .history-section {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
        }

        .hint-text {
            margin-left: 15px;
            font-size: 1.1rem;
        }

        .victory {
            color: #00ff00;
            font-weight: bold;
        }

        .defeat {
            color: #ff4444;
            font-weight: bold;
        }

        .serial-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .serial-connected {
            background: #228B22;
            color: white;
        }

        .serial-disconnected {
            background: #cc0000;
            color: white;
        }

        .exit-fullscreen {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        @media (max-width: 1200px) {
            .columns {
                flex-direction: column;
            }
            
            .hints-column, .game-column {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="fullscreen">
        <button class="exit-fullscreen" onclick="exitFullscreen()">‚§¢ Iziet no pilnekrƒÅna</button>
        
        <div class="serial-status" id="serialStatus">Serial: Nav savienots</div>
        
        <div class="container">
            <div class="header">
                <h1 class="title">üí£ SPRIDZEKƒªA KODA PUZLE üí£</h1>
            </div>

            <div class="columns">
                <!-- KreisƒÅ kolonna - Hinti -->
                <div class="hints-column">
                    <h2 class="section-title">SƒÅkotnƒìjie pavedieni:</h2>
                    <div class="hint-table" id="hintsContainer">
                        <!-- Hinti tiks ƒ£enerƒìti ar JavaScript -->
                    </div>
                </div>

                <!-- LabƒÅ kolonna - Spƒìle -->
                <div class="game-column">
                    <!-- Laika vadƒ´ba -->
                    <div class="timer-section">
                        <div class="time-display" id="timeDisplay">07:00</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        
                        <div class="timer-controls">
                            <button class="btn btn-start" onclick="startTimer()">‚ñ∂Ô∏è START</button>
                            <button class="btn btn-stop" onclick="stopTimer()">‚è∏Ô∏è STOP</button>
                        </div>
                    </div>

                    <!-- Pa≈°reizƒìjƒÅ ievade -->
                    <div class="current-input">
                        <h3 class="section-title">Tava pa≈°reizƒìjƒÅ kombinƒÅcija:</h3>
                        <div class="current-input-text" id="currentInput"></div>
                    </div>

                    <!-- Darbƒ´bu pogas -->
                    <div class="actions">
                        <button class="btn btn-delete" onclick="deleteLast()">‚¨ÖÔ∏è DZƒíST</button>
                        <button class="btn btn-submit" onclick="submitGuess()">‚úÖ IESNIEGT</button>
                    </div>

                    <!-- KrƒÅsu pogas -->
                    <div class="color-buttons" id="colorButtons">
                        <!-- KrƒÅsu pogas tiks ƒ£enerƒìtas ar JavaScript -->
                    </div>

                    <!-- Vƒìsture -->
                    <h3 class="section-title">Tavi mƒìƒ£inƒÅjumi:</h3>
                    <div class="history-section" id="historyContainer">
                        <!-- Vƒìsture tiks aizpildƒ´ta ar JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONSTANTES ---
        const CODE_LENGTH = 5;
        const TOTAL_TIME = 420; // 7 min≈´tes
        const PENALTY = 30;
        const POLL_INTERVAL = 100;

        const COLORS = {
            "BTN1": { name: "Violets", color: "#8A2BE2", textColor: "white" },
            "BTN2": { name: "Zaƒº≈°", color: "#2E8B57", textColor: "white" },
            "BTN3": { name: "Balts", color: "#F8F8FF", textColor: "black" },
            "BTN4": { name: "Melns", color: "#000000", textColor: "white" },
            "BTN5": { name: "Pelƒìks", color: "#808080", textColor: "white" }
        };

        const ORDER = ["BTN1", "BTN2", "BTN3", "BTN4", "BTN5"];

        // --- SPƒíLES STƒÄVOKLIS ---
        let gameState = {
            secret: [],
            current: [],
            timeLeft: TOTAL_TIME,
            timerRunning: false,
            gameOver: false,
            serialPort: null,
            reader: null,
            generatedHints: [],
            history: []
        };

        // --- INICIALIZƒÄCIJA ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            setupColorButtons();
            checkSerialSupport();
        });

        function initializeGame() {
            // ƒ¢enerƒì slepeno kodu
            gameState.secret = Array.from({length: CODE_LENGTH}, () => 
                ORDER[Math.floor(Math.random() * ORDER.length)]
            );
            
            // ƒ¢enerƒì hintus
            gameState.generatedHints = generateHints();
            
            // Atjaunina UI
            renderHints();
            updateTimerDisplay();
            updateCurrentInput();
            
            console.log("Slepenais kods:", gameState.secret.map(c => COLORS[c].name));
        }

        function generateHints() {
            const hints = [];
            for (let i = 0; i < 6; i++) {
                let guess = [...gameState.secret];
                
                // Nejau≈°i izmaina 1-2 pozƒ´cijas
                const changes = Math.floor(Math.random() * 2) + 1;
                for (let j = 0; j < changes; j++) {
                    const pos = Math.floor(Math.random() * CODE_LENGTH);
                    guess[pos] = ORDER[Math.floor(Math.random() * ORDER.length)];
                }
                
                const result = evaluateGuess(guess, true);
                hints.push({ guess, result });
            }
            return hints;
        }

        function evaluateGuess(guess, preview = false) {
            const secretCopy = [...gameState.secret];
            const guessCopy = [...guess];
            let correctPos = 0;
            let wrongPlace = 0;

            // PareizƒÅs pozƒ´cijas
            for (let i = CODE_LENGTH - 1; i >= 0; i--) {
                if (guessCopy[i] === secretCopy[i]) {
                    correctPos++;
                    guessCopy.splice(i, 1);
                    secretCopy.splice(i, 1);
                }
            }

            // PareizƒÅs krƒÅsas nepareizƒÅ vietƒÅ
            for (let g of guessCopy) {
                const index = secretCopy.indexOf(g);
                if (index !== -1) {
                    wrongPlace++;
                    secretCopy.splice(index, 1);
                }
            }

            // Pieskaita sodu, ja nav preview
            if (!preview && gameState.timerRunning && !gameState.gameOver) {
                gameState.timeLeft = Math.max(0, gameState.timeLeft - PENALTY);
                updateTimerDisplay();
            }

            return { correctPos, wrongPlace };
        }

        // --- SERIAL API FUNKCIJAS ---
        async function connectSerial() {
            try {
                if (!('serial' in navigator)) {
                    throw new Error('Web Serial API nav atbalstƒ´ta ≈°ajƒÅ pƒÅrl≈´kprogrammƒÅ');
                }

                gameState.serialPort = await navigator.serial.requestPort();
                await gameState.serialPort.open({ 
                    baudRate: 9600,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });

                updateSerialStatus(true);
                startSerialReading();
                
            } catch (error) {
                console.error('Serial connection error:', error);
                updateSerialStatus(false, error.message);
            }
        }

        async function startSerialReading() {
            try {
                const decoder = new TextDecoder();
                gameState.reader = gameState.serialPort.readable.getReader();
                
                while (true) {
                    const { value, done } = await gameState.reader.read();
                    if (done) {
                        gameState.reader.releaseLock();
                        break;
                    }
                    
                    const text = decoder.decode(value).trim().toUpperCase();
                    processSerialInput(text);
                }
            } catch (error) {
                console.error('Serial reading error:', error);
                updateSerialStatus(false, 'Reading error');
            }
        }

        function processSerialInput(text) {
            if (text.startsWith("BTN") && ORDER.includes(text.substring(0, 4))) {
                addInput(text.substring(0, 4));
            } else if (/^[1-5]$/.test(text)) {
                addInput(`BTN${text}`);
            }
        }

        function updateSerialStatus(connected, message = '') {
            const statusElement = document.getElementById('serialStatus');
            if (connected) {
                statusElement.textContent = 'Serial: Savienots';
                statusElement.className = 'serial-status serial-connected';
            } else {
                statusElement.textContent = `Serial: Nav savienots${message ? ' - ' + message : ''}`;
                statusElement.className = 'serial-status serial-disconnected';
            }
        }

        function checkSerialSupport() {
            if (!('serial' in navigator)) {
                alert('‚ö†Ô∏è Web Serial API nav atbalstƒ´ta. L≈´dzu izmantojiet Chrome, Edge vai Opera.');
            }
        }

        // --- UI FUNKCIJAS ---
        function setupColorButtons() {
            const container = document.getElementById('colorButtons');
            container.innerHTML = '';
            
            ORDER.forEach(btnId => {
                const color = COLORS[btnId];
                const button = document.createElement('button');
                button.className = 'color-btn';
                button.textContent = color.name;
                button.style.backgroundColor = color.color;
                button.style.color = color.textColor;
                button.onclick = () => addInput(btnId);
                container.appendChild(button);
            });
        }

        function renderHints() {
            const container = document.getElementById('hintsContainer');
            container.innerHTML = '';
            
            gameState.generatedHints.forEach(({guess, result}) => {
                const row = document.createElement('div');
                row.className = 'hint-row';
                
                guess.forEach(colorId => {
                    const dot = document.createElement('span');
                    dot.className = 'color-dot';
                    dot.style.backgroundColor = COLORS[colorId].color;
                    row.appendChild(dot);
                });
                
                const hintText = document.createElement('span');
                hintText.className = 'hint-text';
                hintText.textContent = makeHintText(result);
                row.appendChild(hintText);
                
                container.appendChild(row);
            });
        }

        function makeHintText(data) {
            const c = data.correctPos;
            const w = data.wrongPlace;
            
            if (c === 0 && w === 0) return "Nekas nav pareizs.";
            if (c === 1 && w === 0) return "1 pareizs vietƒÅ.";
            if (c > 1 && w === 0) return `${c} pareizi vietƒÅ.`;
            if (c === 0 && w === 1) return "1 pareizs, bet citƒÅ vietƒÅ.";
            if (c === 0 && w > 1) return `${w} pareizi, bet citƒÅs vietƒÅs.`;
            return `${c} vietƒÅ, ${w} citur.`;
        }

        function updateCurrentInput() {
            const container = document.getElementById('currentInput');
            container.innerHTML = '';
            
            if (gameState.current.length === 0) {
                container.textContent = 'Izvƒìlies krƒÅsas...';
                return;
            }
            
            gameState.current.forEach(colorId => {
                const color = COLORS[colorId];
                const tag = document.createElement('span');
                tag.className = 'color-tag';
                tag.textContent = color.name;
                tag.style.backgroundColor = color.color;
                tag.style.color = color.textColor;
                container.appendChild(tag);
            });
            
            // Atjaunina iesnieg≈°anas pogas stƒÅvokli
            document.querySelector('.btn-submit').disabled = gameState.current.length !== CODE_LENGTH;
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            document.getElementById('timeDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const progressPercent = (gameState.timeLeft / TOTAL_TIME) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
        }

        // --- SPƒíLES LOƒ¢IKA ---
        function addInput(btnId) {
            if (gameState.gameOver || gameState.current.length >= CODE_LENGTH) return;
            gameState.current.push(btnId);
            updateCurrentInput();
        }

        function deleteLast() {
            if (gameState.current.length > 0) {
                gameState.current.pop();
                updateCurrentInput();
            }
        }

        function submitGuess() {
            if (gameState.current.length < CODE_LENGTH) {
                alert('Nepilns kods! Ievadi visas 5 krƒÅsas pirms iesnieg≈°anas!');
                return;
            }

            const guess = [...gameState.current];
            gameState.current = [];
            updateCurrentInput();

            if (guess.join() === gameState.secret.join()) {
                endGame(true, guess);
                return;
            }

            if (gameState.timeLeft <= 0) {
                endGame(false, guess);
                return;
            }

            const hintData = evaluateGuess(guess);
            addToHistory(guess, hintData, 'try');
        }

        function addToHistory(guess, hintData, result) {
            const historyContainer = document.getElementById('historyContainer');
            const row = document.createElement('div');
            row.className = 'history-row';
            
            guess.forEach(colorId => {
                const dot = document.createElement('span');
                dot.className = 'color-dot';
                dot.style.backgroundColor = COLORS[colorId].color;
                row.appendChild(dot);
            });
            
            const resultText = document.createElement('span');
            resultText.className = 'hint-text';
            
            if (result === 'win') {
                resultText.textContent = 'üéâ Uzvara!';
                resultText.className += ' victory';
            } else if (result === 'lose') {
                resultText.textContent = 'üí£ Zaudƒìjums!';
                resultText.className += ' defeat';
            } else {
                resultText.textContent = makeHintText(hintData);
            }
            
            row.appendChild(resultText);
            historyContainer.appendChild(row);
            historyContainer.scrollTop = historyContainer.scrollHeight;
            
            gameState.history.push({ guess, hintData, result });
        }

        // --- TIMER FUNKCIJAS ---
        function startTimer() {
            if (!gameState.timerRunning && !gameState.gameOver) {
                gameState.timerRunning = true;
                gameState.timerInterval = setInterval(tick, 1000);
            }
        }

        function stopTimer() {
            gameState.timerRunning = false;
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
        }

        function tick() {
            if (gameState.timerRunning && !gameState.gameOver) {
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    gameState.timeLeft = 0;
                    endGame(false);
                }
            }
        }

        function endGame(victory, guess = null) {
            gameState.gameOver = true;
            stopTimer();
            
            if (guess) {
                addToHistory(guess, null, victory ? 'win' : 'lose');
            }
            
            setTimeout(() => {
                if (victory) {
                    alert('üéâ Tu atminƒìji kodu!');
                    window.open('https://youtube.com', '_blank');
                } else {
                    alert('üí£ Laiks beidzies vai kods nav atminƒìts!');
                    window.open('https://ss.com', '_blank');
                }
            }, 1000);
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        // Pievieno klausƒ´tƒÅju Escape tausti≈Üam
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                exitFullscreen();
            }
        });

        // PƒÅrbauda, vai var ieslƒìgt pilnekrƒÅnu
        document.addEventListener('dblclick', function() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            }
        });

        // Eksportƒì funkcijas globƒÅlajƒÅ scopƒÅ
        window.connectSerial = connectSerial;
        window.startTimer = startTimer;
        window.stopTimer = stopTimer;
        window.addInput = addInput;
        window.deleteLast = deleteLast;
        window.submitGuess = submitGuess;
        window.exitFullscreen = exitFullscreen;
    </script>
</body>
</html>
